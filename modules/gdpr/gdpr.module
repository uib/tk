<?php
/**
 * @file
 * Code for the GDPR feature.
 */

include_once 'gdpr.features.inc';

/**
 * Implements hook_entity_view_alter().
 */
function gdpr_entity_view_alter(&$build, $type) {
  if ($type != 'node')
    return;
  if ($build['#bundle'] != 'gdpr_processing')
    return;
  foreach (array('field_gdpr_controller_person') as $user_field) {
    if (isset($build[$user_field])) {
      $i = 0;
      while (isset($build[$user_field][$i])) {
        $u = $build[$user_field]['#items'][$i]['entity'];
        $build[$user_field][$i]['#markup'] = l($u->field_full_name['und'][0]['value'], 'http://www.uib.no/user/uib/' . $u->name);
        unset($build[$user_field][$i]['#theme']);
        $i++;
      }
    }
  }
}

/**
 * Implements hook_form_alter().
 */
 function gdpr_form_gdpr_processing_node_form_alter(&$form, &$form_state, $form_id) {
  $form['title']['#required'] = FALSE;
  $form['title']['#description'] = 'Behandlingens tittel brukes i opplistinger. Knyttes behandlingen til en tjeneste blir tittel satt fra denne.';
  $form['field_gdpr_data_special_type']['#states'] = array(
    'visible' => array(
      ':input[name="field_gdpr_data_special[und]"]' => array('value' => 'y'),
    ),
  );
  $form['field_gdpr_data_special_lawfulne']['#states'] = array(
    'visible' => array(
      ':input[name="field_gdpr_data_special[und]"]' => array('value' => 'y'),
    ),
  );
}

/**
 * Implements hook_node_presave().
 */
function gdpr_node_presave($node) {
  if (empty($node->title)) {
    if (!empty($node->field_gdpr_service['und'])) {
      $service_node = node_load($node->field_gdpr_service['und'][0]['target_id']);
      $node->title = $service_node->title;
    }
    else {
      $cnt = db_query("SELECT count(*) FROM {node} n WHERE n.type = 'gdpr_processing'")->fetchField();
      $cnt++;
      $node->title = "Behandling #$cnt";
    }
  }
}
